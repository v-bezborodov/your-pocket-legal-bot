import OpenAI from 'openai';
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function askAI(userQuestion: string): Promise<string> {
  try {
    console.log('–ó–∞–ø–∏—Ç –≤ –®–Ü –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ..')
    const completion = await openai.chat.completions.create({
      model: 'gpt-5-nano',
      messages: [
        { role: 'system', content: '–¢–∏ –≤–∏—Å–æ–∫–æ–∫–ª–∞—Å–Ω–∏–π –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∞–¥–≤–æ–∫–∞—Ç –∑ –≥—Ä–æ–º–∞–¥—è–Ω—Å—å–∫–∏—Ö –ø—Ä–∞–≤ –≤ –£–∫—Ä–∞—ó–Ω—ñ. –ü–æ—è—Å–Ω–∏ –ø–æ–∫—Ä–æ–∫–æ–≤–æ, —è–∫—â–æ –≤–æ–Ω–∏ –ø–æ—Ä—É—à—É—é—Ç—å –º–æ—ó –ø—Ä–∞–≤–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–æ—Å—è—Ç—å –ø–æ–∫–∞–∑–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏, –≤–∏–º–∞–≥–∞—é—Ç—å —Ä–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω, –ø—Ä–æ–≤–æ–¥—è—Ç—å –æ–±—à—É–∫ –±–µ–∑ –ø—ñ–¥—Å—Ç–∞–≤, —Ö–∞–º–ª—è—Ç—å –∞–±–æ –∑–∞—Ç—Ä–∏–º—É—é—Ç—å –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω—å) ‚Äî –Ω–∞–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ñ—Ä–∞–∑–∏ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Å—Ç–∞—Ç—Ç—ñ –∑–∞–∫–æ–Ω—ñ–≤ –£–∫—Ä–∞—ó–Ω–∏ (–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü—ñ—è, –ó–∞–∫–æ–Ω ¬´–ü—Ä–æ –ù–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω—É –ø–æ–ª—ñ—Ü—ñ—é¬ª, –ö–ü–ö, –ö–£–ø–ê–ü, –ø–æ—Å—Ç–∞–Ω–æ–≤–∏ –ö–∞–±–ú—ñ–Ω—É). –î–æ–¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó, —è–∫ –∑–∞–∫–æ–Ω–Ω–æ –∑–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –ø–æ—Ä—É—à–µ–Ω–Ω—è (–≤—ñ–¥–µ–æ, —Å–≤—ñ–¥–∫–∏, —Ç–æ—â–æ). –§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - –∫–æ—Ä–æ—Ç–∫–æ –¥–æ 4000 —Å–∏–º–≤–æ–ª—ñ–≤, —á—ñ—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ' },
        { role: 'user', content: userQuestion }
      ],
    });

    return completion.choices[0]?.message?.content?.trim() || '–ù–∞ –∂–∞–ª—å, —è –Ω–µ –º–∞—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è.';

  } catch (err: any) {
    console.error('‚ùå AI request failed:', err);

    if (err instanceof OpenAI.APIError || err.status === 429) {
      return "–ë–æ—Ç —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–æ –∑–∞–ø–∏—Ç–∞—Ö. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.";
    }

    // Handle known OpenAI API errors
    if (err instanceof OpenAI.APIError) {
      console.error('OpenAI API error:', {
        status: err.status,
        name: err.name,
        message: err.message,
        requestId: err.request_id,
      });
    }


    // Return a friendly fallback to user
    return (
      '‚ö†Ô∏è –í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è —Ç–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –¥–æ AI.\n\n' +
      '–°–ø—Ä–æ–±—É–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–∑–Ω—ñ—à–µ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n' +
      'üì© @legal_support_admin'
    );
  }
}
